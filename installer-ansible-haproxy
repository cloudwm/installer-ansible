#!/bin/bash

source installer-ansible-pull-role
source startup-cwm.sh
SERVICE_ENV='service=haproxy'

pullrole stable ${SERVICE_ENV}

echo "Adding descriptions" | log
echo "HAProxy Address: ${CWM_DISPLAYED_ADDRESS}" >> ~/description.txt
echo " " >> ~/description.txt
echo "HAProxy Stats Web UI: https://${CWM_DISPLAYED_ADDRESS}:8404/stats" >> ~/description.txt
echo "HAProxy Stats Web UI Username: admin" >> ~/description.txt
echo "HAProxy Stats Web UI Password: ${ADMINPASSWORD}" >> ~/description.txt
echo " " >> ~/description.txt
echo "HAProxy config file: /etc/haproxy/haproxy.cfg" >> ~/description.txt
echo " " >> ~/description.txt
echo "HAProxy examples: /usr/share/doc/haproxy/examples" >> ~/description.txt
echo "HAProxy documentation (on-server): /usr/share/doc/haproxy/" >> ~/description.txt
echo "HAProxy documentation (online): http://cbonte.github.io/haproxy-dconv/2.4/intro.html" >> ~/description.txt
echo " " >> ~/description.txt

set -x
curl --location -f -X PUT --retry-connrefused --retry 3 --retry-delay 2 -H "AuthClientId: ${CWM_APICLIENTID}" -H "AuthSecret: ${CWM_APISECRET}" "https://$CWM_URL/svc/server/$CWM_UUID/description" --data-urlencode $'description='"$(cat ~/description.txt)"
set +x

rm -rf /opt/installer-ansible
rm -rf ~/.ansible*
